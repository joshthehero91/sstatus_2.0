(BOLD='\e[1m';LBLU='\e[94m';NC='\e[0m';echo "";echo -e "${BOLD}-----General Stats-----${NC}";echo "";echo -e "${BOLD}${LBLU}Hostname: "${NC};hostname;echo ""; echo -e "${BOLD}${LBLU}Uptime:"${NC};uptime;echo "";echo -e "${BOLD}${LBLU}Operating System:${NC}" ;if [[ -a /etc/redhat-release ]] ;then cat /etc/redhat-release ;fi ;if [[ -a /etc/lsb-release ]] ;then lsb_release -a ;fi ;if [[ -a /etc/debian_version ]] ; then cat /etc/debian_version ;fi ;echo "";echo -e "${BOLD}${LBLU}Loaded Kernel:${NC}" ;uname -r;echo ""; echo -e "${BOLD}${LBLU}Kernels Installed:${NC}" ;rpm -qa | grep kernel | egrep -iv 'tools|headers|care|update' | awk -F"kernel-" '{print $2}'| sort -nr;echo "";echo -e "${BOLD}${LBLU}Disk Usage:${NC}" ;df -h ;df -Ph| awk '0+$5 >= 80 {print}' ;echo ""; echo -e "${BOLD}${LBLU}Memory Usage:${NC}" ;free -h ;echo ""; echo -e "${BOLD}${LBLU}Potential OOM notifications:${NC} $(grep Kill /var/log/messages|wc -l)"; echo -en "${BOLD}${LBLU}CPU(s): "${NC};grep --count ^processor /proc/cpuinfo;echo "";echo -e "${BOLD}-----Apache Stats-----${NC}";echo "";echo -e "${BOLD}${LBLU}Apache Version:${NC}";httpd -V|grep version|awk '{print $3,$4}';echo "";echo -e "${BOLD}${LBLU}Apache MPM:${NC}";httpd -V|grep MPM|awk '{print $NF}';echo "";echo -e "${BOLD}${LBLU}Checking for Apache confs:${NC}";if [[ -s /usr/local/apache/conf/includes/pre_virtualhost_global.conf ]];then echo -e "${BOLD}${LBLU}Contents of /usr/local/apache/conf/includes/pre_virtualhost_global.conf:${NC}";cat /usr/local/apache/conf/includes/pre_virtualhost_global.conf;else echo -e "${BOLD}${LBLU}No global Apache configurations in place.${NC}";fi;echo "";if [[ -s /usr/local/apache/conf/includes/pre_virtualhost_2.conf ]];then echo -e "${BOLD}${LBLU}Contents of /usr/local/apache/conf/includes/pre_virtualhost_2.conf:${NC}";cat /usr/local/apache/conf/includes/pre_virtualhost_2.conf;else echo -e "${BOLD}${LBLU}No Apache 2 configurations in place.${NC}";fi;echo "";ea_check () { if [[ $(httpd -V|egrep "HTTPD_ROOT=\"\/etc\/apache2") ]];then return;fi; } ;if ea_check $1;then if [[ $(grep max /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/error.log) ]] ;then echo -e "${BOLD}${LBLU}Potential MaxChildren limit reached errors:${NC}" ; grep max /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/error.log | wc -l ;echo -e "${BOLD}${LBLU}Top 5 offending domains:${NC}"; grep max /opt/cpanel/ea-php*/root/usr/var/log/php-fpm/error.log|awk '{print $5}'|sort|uniq -c|sort -rnk1|head -n5 ;else echo -e "${BOLD}${LBLU}No PHP-FPM limit errors"${NC} ;fi ;if [[ $(grep MaxRequestWorkers /usr/local/apache/logs/error_log) ]] ;then echo -ne "${BOLD}${LBLU}Potential MaxRequestWorkers limit errors: "${NC} ; grep MaxRequestWorkers /usr/local/apache/logs/error_log| wc -l ;else echo -e "${BOLD}${LBLU}No Apache limit errors.${NC}" ;fi;fi;echo "";echo -e "${BOLD}-----PHP Stats-----${NC}";echo "";if [[ $(httpd -V|egrep "HTTPD_ROOT=\"\/etc\/apache2") ]]; then echo -e "${BOLD}${LBLU}Inherent PHP version:${NC}";php -v|head -n1|awk '{print$1" "$2}'; echo -e "${BOLD}${LBLU}PHP versions in use on `hostname`:${NC}" ;grep "phpversion:" /var/cpanel/userdata/*/*|awk '{print $2}'|sort|uniq -c|sort -rnk1;echo "";if [[ $(yum list installed|grep "memcache\|opcache") ]]; then echo -e "${BOLD}${LBLU}PHP caching:${NC}";yum list installed|grep "memcache\|opcache"|awk '{print $1}'; else echo -e "${BOLD}${LBLU}No PHP caching${NC}";fi;else echo -e "${BOLD}${LBLU}Inherent PHP version:${NC}:"; php -v|head -n1|awk '{print$1" "$2}';if [[ $(php -m|grep cache) ]]; then echo -e "${BOLD}${LBLU}PHP caching:${NC}";php -m|grep cache; else echo -e "${BOLD}${LBLU}No PHP caching${NC}";fi;fi; echo ""; echo -e "${BOLD}${LBLU}Checking various memory_limit settings:"${NC}; echo -en "Current loaded php.ini file: ";echo -e ${LBLU}${BOLD}$(php -i|grep "Loaded Configuration File"|awk '{print$5}'|head -1);echo -e $(cat `php -i|grep "Loaded Configuration File"|awk '{print$5}'|head -1`| grep memory_limit)${NC};echo "";echo -e "${BOLD}-----cPanel Stats-----${NC}";echo "";echo -ne "${BOLD}${LBLU}cPanel: ${NC}";cat /usr/local/cpanel/version ;echo -ne "${BOLD}${LBLU}cPanel accounts: ${NC}";/scripts/updateuserdomains && cat /etc/trueuserdomains|wc -l ;echo -ne "${BOLD}${LBLU}cPanel domains: ${NC}";awk '/DNS*=/' /var/cpanel/users/*|grep -vE '(^| )DNS=( |$)'|cut -c 5-|wc -l ;echo "" ;if [[ $(httpd -V|egrep "HTTPD_ROOT=\"\/etc\/apache2") ]]; then echo -e "${BOLD} ${BLUB}--EasyApache 4 in use--${NC}"; echo $EA4H; else echo -e "${BOLD} ${BLUB}--EasyApache 3 in use--${NC}"; echo $EA3H; fi;echo -ne "${BOLD}${LBLU}Checking cPanel backups:${NC}";echo "";grep --color=never -i "enable\|dir\|retent" /var/cpanel/backups/config;echo "";echo -e "${BOLD}-----MySQL Stats-----${NC}";echo "";echo -e "${BOLD}${LBLU}MySQL Version:${NC}";mysql --version;echo "";echo -e "${BOLD}${LBLU}MySQL data usage:${NC}";mysql -Bse 'show variables like "datadir";'|awk '{print $2}'|xargs -I{} find {} -type f -printf "%s %f\n"|awk -F'[ ,.]' '{print $1, $NF}'|awk '{array[$2]+=$1} END {for (i in array) {printf("%-15s %s\n", sprintf("%.3f MB", array[i]/1048576), i)}}' | egrep --color=none '(MYI|ibd)'; echo "";echo -e "${BOLD}${LBLU}Note:${NC} Set innodb_buffer_pool_size based on the sum of 'ibd' and 'ibdata1', and set key_buffer_size based on the total listed for 'MYI'. See here for reference --> http://hostbaitor.com/mysql/performance#mysql-configuration .";echo ""; echo -e "${BOLD}${LBLU}Try to set buffers to the following:${NC}";mysql -Bse 'show variables like "datadir";'|awk '{print $2}'|xargs -I{} find {} -type f -printf "%s %f\n"|awk -F'[ ,.]' '{print $1, $NF}'|awk '{array[$2]+=$1} END {for (i in array) {printf("%-15s %s\n", sprintf("%.3f MB", array[i]/1048576), i)}}' | awk '{if($3~/MYI/)print"key_buffer_size\t\t",$1"M"};{if($3~/ibd/)a+=$1}END{print "innodb_buffer_pool_size\t",a"M"}';echo "";echo -e "${BOLD}${LBLU}Important MySQL configurations:${NC}";grep --color=never "max_connections\|key_buffer\|max_allowed_packet\|innodb_buffer_pool_size" /etc/my.cnf;mysql -e "SHOW GLOBAL STATUS;"|grep --color=none Max_used_;echo "";echo -e "${BOLD}${LBLU}Current MySQL queries:${NC}";mysqladmin proc stat;echo "")
